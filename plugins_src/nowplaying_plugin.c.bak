#include "llizard_plugin.h"
#include "llz_sdk.h"
#include "raylib.h"

#include <math.h>
#include <stdio.h>
#include <string.h>

static int g_screenWidth = 800;
static int g_screenHeight = 480;
static float g_trackPosition = 0.0f;
static float g_trackDuration = 210.0f;
static bool g_isPlaying = true;
static bool g_wantsClose = false;

static void PluginInit(int width, int height)
{
    g_screenWidth = width;
    g_screenHeight = height;
    g_trackPosition = 46.0f;
    g_trackDuration = 210.0f;
    g_isPlaying = true;
    g_wantsClose = false;
}

static void PluginUpdate(const LlzInputState *input, float delta)
{
    bool space = IsKeyPressed(KEY_SPACE) || (input && input->selectPressed);
    bool back = IsKeyPressed(KEY_BACKSPACE) || (input && input->backPressed);
    bool right = IsKeyPressed(KEY_RIGHT) || (input && (input->scrollDelta > 0.0f || input->upPressed));
    bool left = IsKeyPressed(KEY_LEFT) || (input && (input->scrollDelta < 0.0f || input->downPressed));

    if (space) g_isPlaying = !g_isPlaying;
    if (right) g_trackPosition += 5.0f;
    if (left) g_trackPosition -= 5.0f;
    if (back) g_wantsClose = true;

    if (g_isPlaying) {
        g_trackPosition += delta;
    }

    if (g_trackPosition < 0.0f) g_trackPosition = 0.0f;
    if (g_trackPosition > g_trackDuration) g_trackPosition = 0.0f;
}

static void DrawProgressBar(Rectangle bounds, float progress)
{
    DrawRectangleRounded(bounds, 0.4f, 8, (Color){255, 255, 255, 70});
    Rectangle fill = bounds;
    fill.width = bounds.width * progress;
    DrawRectangleRounded(fill, 0.4f, 8, (Color){248, 141, 65, 255});
}

static void PluginDraw(void)
{
    Color left = (Color){32, 18, 36, 255};
    Color right = (Color){64, 36, 80, 255};
    DrawRectangleGradientH(0, 0, g_screenWidth, g_screenHeight, left, right);

    DrawText("Now Playing", 24, 24, 34, RAYWHITE);

    const char *title = "Texas";
    const char *artist = "Sharleen Spiteri";
    DrawText(title, 24, 90, 48, RAYWHITE);
    DrawText(TextFormat("%s", artist), 24, 150, 28, (Color){220, 220, 220, 255});

    Rectangle progress = {24, 210, g_screenWidth - 48, 10};
    float pct = g_trackDuration > 0.0f ? g_trackPosition / g_trackDuration : 0.0f;
    if (pct < 0.0f) pct = 0.0f;
    if (pct > 1.0f) pct = 1.0f;
    DrawProgressBar(progress, pct);

    DrawText(TextFormat("%02d:%02d", (int)g_trackPosition / 60, (int)fmodf(g_trackPosition, 60.0f)),
             24, 230, 22, RAYWHITE);
    DrawText(TextFormat("-%02d:%02d", (int)(g_trackDuration - g_trackPosition) / 60,
                       (int)fmodf(g_trackDuration - g_trackPosition, 60.0f)),
             g_screenWidth - 120, 230, 22, RAYWHITE);

    DrawText(g_isPlaying ? "Playing" : "Paused", 24, 280, 28, RAYWHITE);
    DrawText("SPACE/Select Play-Pause  LEFT/RIGHT/Knob Seek  BACK/Bksp Exit", 24, g_screenHeight - 36, 20, RAYWHITE);
}

static void PluginShutdown(void)
{
    g_wantsClose = false;
}

static bool PluginWantsClose(void)
{
    return g_wantsClose;
}

static LlzPluginAPI g_api = {
    .name = "Now Playing",
    .description = "Sample now playing plugin",
    .init = PluginInit,
    .update = PluginUpdate,
    .draw = PluginDraw,
    .shutdown = PluginShutdown,
    .wants_close = PluginWantsClose
};

const LlzPluginAPI *LlzGetPlugin(void)
{
    return &g_api;
}
